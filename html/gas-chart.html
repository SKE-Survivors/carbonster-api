<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Gas Chart</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body style="text-align: center;">
  <h1 id="title"></h1>
  <h3 id="error"></h3>

  <div id="chart" style="width:100%;height:75vh;"></div>

  <script>
    var url = new URL(window.location.href)
    var code = url.searchParams.get("code")
    var inThai = code.length != 2
    var title = url.searchParams.get("title")
    document.getElementById("title").innerHTML = title

    if (inThai) {
      var body = JSON.stringify({
        query: `
            {
              airQualityTH(province: "${code}") {
                date
                carbonmonoxide
                methane
                ozone
              }
            }`
      })
    } else {
      var body = JSON.stringify({
        query: `
            {
              airQuality(country: "${code}") {
                date
                carbonmonoxide
                methane
                ozone
              }
            }`
      })
    }

    async function createChart() {
      var resp = await fetch('http://localhost:3000/graphql', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: body
      });
      var json = await resp.json();
      var table = json.data;
      // console.log(table)

      if (inThai) {
        if (table.airQualityTH == null) {
          document.getElementById("error").innerHTML = "Still No Data"
          return;
        }
        var data = [
          {
            x: table.airQualityTH.map(row => row.date),
            y: table.airQualityTH.map(row => row.carbonmonoxide),
            type: 'line',
            name: "carbonmonoxide",
          },
          {
            x: table.airQualityTH.map(row => row.date),
            y: table.airQualityTH.map(row => row.methane),
            type: 'line',
            name: "methane",
          },
          {
            x: table.airQualityTH.map(row => row.date),
            y: table.airQualityTH.map(row => row.ozone),
            type: 'line',
            name: "ozone",
          }
        ];
      } else {
        if (table.airQuality == null) {
          document.getElementById("error").innerHTML = "Still No Data"
          return;
        }
        var data = [
          {
            x: table.airQuality.map(row => row.date),
            y: table.airQuality.map(row => row.carbonmonoxide),
            type: 'line',
            name: "carbonmonoxide",
          },
          {
            x: table.airQuality.map(row => row.date),
            y: table.airQuality.map(row => row.methane),
            type: 'line',
            name: "methane",
          },
          {
            x: table.airQuality.map(row => row.date),
            y: table.airQuality.map(row => row.ozone),
            type: 'line',
            name: "ozone",
          }
        ];
      }

      var layout = {
        title: 'Average Gas Volume for ' + title,
        xaxis: {
          title: 'Date'
        },
        yaxis: {
          title: 'Gas Volume (mol/m2)',
          range: [0, .5]
        }
      };
      var config = { responsive: true };
      Plotly.newPlot("chart", data, layout, config);
    }
    createChart();
  </script>
</body>

</html>