<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Gas Chart</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <link rel="icon" href="img/logo.ico">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="layer"></div>
  <!-- ! Body -->
  <a class="skip-link sr-only" href="#skip-target">Skip to content</a>
  <div class="page-flex">
    <!-- ! Sidebar -->
    <!-- TODO: add aside -->
    <div class="main-wrapper">
      <!-- ! Main nav -->
      <nav class="main-nav--bg">
        <div class="main-nav">
          <div class="main-nav-end mx-4">
            <button class="sidebar-toggle transparent-btn" title="Menu" type="button">
              <span class="sr-only">Toggle menu</span>
              <span class="icon menu-toggle--gray" aria-hidden="true"></span>
            </button>
          </div>
        </div>
      </nav>
      <!-- ! Main -->
      <main class="main users chart-page" id="skip-target">
        <div class="container">
          <h1 id="title"></h1><br><br>
          <h3 id="error"></h3>
          <div id="chart" style="width:100%;height:75vh;"></div>
        </div>
      </main>
    </div>
  </div>

  <script>
    var url = new URL(window.location.href)
    var code = url.searchParams.get("code")
    var inThai = code.length != 2
    var title = url.searchParams.get("title")
    document.getElementById("title").innerHTML = title

    if (inThai) {
      var body = JSON.stringify({
        query: `
              {
                airQualityTH(province: "${code}") {
                  date
                  carbonmonoxide
                  methane
                  ozone
                }
              }`
      })
    } else {
      var body = JSON.stringify({
        query: `
              {
                airQuality(country: "${code}") {
                  date
                  carbonmonoxide
                  methane
                  ozone
                }
              }`
      })
    }

    async function createChart() {
      var resp = await fetch('http://localhost:3000/graphql', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: body
      });
      var json = await resp.json();
      var table = json.data;
      // console.log(table)

      if (inThai) {
        if (table.airQualityTH == null) {
          document.getElementById("error").innerHTML = "Still No Data"
          return;
        }
        var data = [
          {
            x: table.airQualityTH.map(row => row.date),
            y: table.airQualityTH.map(row => row.carbonmonoxide),
            type: 'line',
            name: "carbonmonoxide",
          },
          {
            x: table.airQualityTH.map(row => row.date),
            y: table.airQualityTH.map(row => row.methane),
            type: 'line',
            name: "methane",
          },
          {
            x: table.airQualityTH.map(row => row.date),
            y: table.airQualityTH.map(row => row.ozone),
            type: 'line',
            name: "ozone",
          }
        ];
      } else {
        if (table.airQuality == null) {
          document.getElementById("error").innerHTML = "Still No Data"
          return;
        }
        var data = [
          {
            x: table.airQuality.map(row => row.date),
            y: table.airQuality.map(row => row.carbonmonoxide),
            type: 'line',
            name: "carbonmonoxide",
          },
          {
            x: table.airQuality.map(row => row.date),
            y: table.airQuality.map(row => row.methane),
            type: 'line',
            name: "methane",
          },
          {
            x: table.airQuality.map(row => row.date),
            y: table.airQuality.map(row => row.ozone),
            type: 'line',
            name: "ozone",
          }
        ];
      }

      var layout = {
        title: 'Average Gas Volume for ' + title,
        xaxis: {
          title: 'Date'
        },
        yaxis: {
          title: 'Gas Volume (mol/m2)',
          range: [0, .5]
        }
      };
      var config = { responsive: true };
      Plotly.newPlot("chart", data, layout, config);
    }
    createChart();
  </script>
  <!-- Icons library -->
  <script src="plugins/feather.min.js"></script>
  <!-- Custom scripts -->

  <script src="js/script.js"></script>
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
</body>

</html>